# BIRD Configuration for Mock ISP
# AS 65001 - Simulated Internet Service Provider
# Router ID: 192.0.2.100
# Purpose: Testing BGP upstream connectivity for mesh network

# Router ID (ISP)
router id 192.0.2.100;

# Logging
log syslog all;
debug protocols { states, routes, filters };

# Device protocol - scan network interfaces
protocol device {
    scan time 10;
}

# Kernel protocol - sync routes with kernel routing table
protocol kernel {
    ipv4 {
        import none;
        export all;
    };
}

# Static routes - ISP-announced prefixes (RFC 5737 TEST-NET ranges)
protocol static isp_routes {
    ipv4;

    # TEST-NET-1 (RFC 5737)
    route 192.0.2.0/24 blackhole;

    # TEST-NET-2 (RFC 5737)
    route 198.51.100.0/24 blackhole;

    # TEST-NET-3 (RFC 5737)
    route 203.0.113.0/24 blackhole;
}

# BGP protocol - Customer primary connection (via 172.30.0.0/24)
protocol bgp customer_primary {
    description "Customer AS 65000 (Primary Link)";
    local 172.30.0.2 as 65001;
    neighbor 172.30.0.3 as 65000;

    ipv4 {
        next hop self;

        # Import customer routes with filtering
        import filter {
            # Accept customer prefixes
            if net ~ [10.100.0.0/24, 10.200.0.0/24] then {
                print "ISP (Primary): Accepting customer route ", net, " from AS65000";
                accept;
            }

            # Reject TINC mesh internal network (should not be announced)
            if net ~ [44.30.127.0/24] then {
                print "ISP (Primary): Rejecting internal mesh route ", net;
                reject;
            }

            # Reject anything else
            print "ISP (Primary): Rejecting unknown route ", net;
            reject;
        };

        # Export ISP routes to customer
        export filter {
            # Announce ISP prefixes (static routes)
            if proto = "isp_routes" then {
                print "ISP (Primary): Announcing ", net, " to customer AS65000";
                accept;
            }
            reject;
        };
    };

    # BGP timers
    hold time 90;
    keepalive time 30;
}

# BGP protocol - Customer secondary connection (via 172.31.0.0/24)
protocol bgp customer_secondary {
    description "Customer AS 65000 (Secondary Link)";
    local 172.31.0.2 as 65001;
    neighbor 172.31.0.3 as 65000;

    ipv4 {
        next hop self;

        # Import customer routes with filtering
        import filter {
            # Accept customer prefixes
            if net ~ [10.100.0.0/24, 10.200.0.0/24] then {
                print "ISP (Secondary): Accepting customer route ", net, " from AS65000";
                accept;
            }

            # Reject TINC mesh internal network (should not be announced)
            if net ~ [44.30.127.0/24] then {
                print "ISP (Secondary): Rejecting internal mesh route ", net;
                reject;
            }

            # Reject anything else
            print "ISP (Secondary): Rejecting unknown route ", net;
            reject;
        };

        # Export ISP routes to customer
        export filter {
            # Announce ISP prefixes (static routes)
            if proto = "isp_routes" then {
                print "ISP (Secondary): Announcing ", net, " to customer AS65000";
                accept;
            }
            reject;
        };
    };

    # BGP timers
    hold time 90;
    keepalive time 30;
}

# BGP Peer Configurations
# Multi-homing to ISP with two uplinks
#
# Template variables:
#   node_id: This node's numeric ID (e.g., 1)
#   bgp_as: BGP AS number (e.g., 65000)
#   isp_enabled: Enable ISP upstream (true/false, default: false)
#   isp_local_ip: Optional macvlan IP for external ISP connectivity
#
# Configuration creates two ISP uplinks with different preferences:
# - isp_primary: Higher local-pref (200) via 172.30.0.0/24
# - isp_secondary: Lower local-pref (150) via 172.31.0.0/24

# ISP Upstream (eBGP) - Only on border router (node1) when ISP is enabled
{% if node_id == 1 and isp_enabled == 'true' %}

# Primary ISP uplink (preferred path)
protocol bgp isp_primary {
    description "ISP Upstream AS 65001 (Primary - 172.30.0.0/24)";
    # Use macvlan LAN IP for direct connectivity (fallback to isp-net IP)
    {% if isp_local_ip is defined %}
    local {{ isp_local_ip }} as {{ bgp_as }};
    neighbor {{ isp_neighbor }} as 65001;
    {% else %}
    local 172.30.0.3 as {{ bgp_as }};
    neighbor 172.30.0.2 as 65001;
    {% endif %}

    ipv4 {
        import filter {
            bgp_local_pref = 200;  # Higher preference
            print "Accepting ISP route ", net, " via primary link with local-pref 200";
            accept;
        };
        export filter export_to_isp;
    };

    # BGP timers
    hold time 90;
    keepalive time 30;
    connect retry time 30;
}

# Secondary ISP uplink (backup path)
protocol bgp isp_secondary {
    description "ISP Upstream AS 65001 (Secondary - 172.31.0.0/24)";
    local 172.31.0.3 as {{ bgp_as }};
    neighbor 172.31.0.2 as 65001;

    ipv4 {
        import filter {
            bgp_local_pref = 150;  # Lower preference (backup)
            print "Accepting ISP route ", net, " via secondary link with local-pref 150";
            accept;
        };
        export filter export_to_isp;
    };

    # BGP timers
    hold time 90;
    keepalive time 30;
}

{% endif %}

# BIRD Configuration for Border Router (WiFi Test)
# AS 65000 - Border Router
# Purpose: Connect ISP to TINC mesh

# Router ID (use your laptop WiFi IP)
router id 192.168.68.119;  # ← YOUR Laptop n1 WiFi IP

# Logging
log syslog all;
debug protocols { states, routes, filters };

# Device protocol - scan network interfaces
protocol device {
    scan time 10;
}

# Kernel protocol - sync routes with kernel routing table
protocol kernel {
    ipv4 {
        import all;  # Import kernel routes to BIRD
        export all;  # Export BIRD routes to kernel
    };
}

# Direct protocol - learn directly connected networks
protocol direct {
    ipv4;
    interface "tinc0";  # Learn TINC mesh subnet
}

# Static routes (optional fallbacks)
protocol static {
    ipv4;
}

# BGP protocol - ISP connection
protocol bgp isp_primary {
    description "ISP AS 65001";
    local 192.168.68.119 as 65000;  # ← YOUR Laptop n1 WiFi IP
    neighbor 192.168.68.120 as 65001;  # ← RPi WiFi IP

    ipv4 {
        # Import routes from ISP
        import filter {
            # Accept ISP prefixes
            if net ~ [192.0.2.0/24, 198.51.100.0/24, 203.0.113.0/24] then {
                print "Border: Accepting ISP route ", net;
                accept;
            }
            print "Border: Rejecting unknown ISP route ", net;
            reject;
        };

        # Export routes to ISP
        export filter {
            # CRITICAL: Export TINC mesh subnet so ISP can route to it
            if net ~ [44.30.127.0/24] then {
                print "Border: Announcing TINC mesh ", net, " to ISP";
                accept;
            }

            # Accept other customer prefixes
            if net ~ [10.100.0.0/24, 10.200.0.0/24] then {
                print "Border: Announcing customer prefix ", net, " to ISP";
                accept;
            }

            # Reject everything else
            print "Border: Rejecting unknown prefix ", net, " to ISP";
            reject;
        };
    };

    # BGP timers
    hold time 90;
    keepalive time 30;
}

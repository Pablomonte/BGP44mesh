# Netmaker Server - Core Components Only
# Runs behind nginx reverse proxy (TLS handled externally)

services:
  # Netmaker Server
  netmaker:
    image: gravitl/netmaker:v0.24.2
    container_name: netmaker
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      SERVER_NAME: "${SERVER_NAME:-netmaker}"
      SERVER_HOST: "${SERVER_HOST}"
      SERVER_API_CONN_STRING: "${SERVER_HOST}"
      SERVER_HTTP_HOST: "${SERVER_HOST}"
      API_PORT: "${NETMAKER_API_PORT:-8443}"
      BROKER_ENDPOINT: "mqtt://${SERVER_HOST}:${MQTT_PORT:-1883}"
      MASTER_KEY: "${MASTER_KEY}"
      MQ_HOST: "mq"
      MQ_PORT: "${MQTT_PORT:-1883}"
      DATABASE: "sqlite"
      NODE_ID: "netmaker-server"
      VERBOSITY: "3"
    volumes:
      - netmaker_data:/root/data
      - netmaker_certs:/etc/netmaker
    ports:
      - "${NETMAKER_API_PORT:-8443}:8443"           # API (HTTP, proxied by nginx)
      - "${WIREGUARD_PORT:-51821}:51821/udp"        # WireGuard
    depends_on:
      - mq
    restart: unless-stopped

  # MQTT Broker (Mosquitto) for Netmaker
  mq:
    image: eclipse-mosquitto:2
    container_name: netmaker-mq
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mq_data:/mosquitto/data
    ports:
      - "${MQTT_PORT:-1883}:1883"
    restart: unless-stopped

volumes:
  netmaker_data:
  netmaker_certs:
  mq_data:

# Border Router - Laptop n1
# AS 65000 - BGP to ISP + Netmaker server

services:
  bird-border:
    build: .
    container_name: bird-border
    hostname: border
    cap_add:
      - NET_ADMIN
    volumes:
      - ./bird.conf:/etc/bird/bird.conf:ro
    network_mode: host
    restart: unless-stopped

  # Netmaker Server
  netmaker:
    image: gravitl/netmaker:v0.24.2
    container_name: netmaker
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      SERVER_NAME: "netmaker"
      SERVER_HOST: "${SERVER_HOST:-172.30.0.100}"  # Physical IP of this machine
      SERVER_API_CONN_STRING: "${SERVER_HOST:-172.30.0.100}:8081"
      COREDNS_ADDR: "${SERVER_HOST:-172.30.0.100}"
      API_PORT: "8081"
      MASTER_KEY: "${MASTER_KEY:-changeme}"
      MQ_HOST: "mq"
      MQ_PORT: "1883"
      DATABASE: "sqlite"
      NODE_ID: "netmaker-server"
      VERBOSITY: "1"
    volumes:
      - netmaker_data:/root/data
      - netmaker_certs:/etc/netmaker
    ports:
      - "8081:8081"      # API
      - "51821:51821/udp" # WireGuard
    depends_on:
      - mq
    restart: unless-stopped

  # MQTT Broker for Netmaker
  mq:
    image: eclipse-mosquitto:2
    container_name: netmaker-mq
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mq_data:/mosquitto/data
    ports:
      - "1883:1883"
    restart: unless-stopped

  # Netclient on this node
  netclient:
    image: gravitl/netclient:v0.24.2
    container_name: netclient
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
    network_mode: host
    volumes:
      - netclient_data:/etc/netclient
    environment:
      TOKEN: "${ENROLLMENT_TOKEN:-}"  # Set after network creation
    restart: unless-stopped

volumes:
  netmaker_data:
  netmaker_certs:
  mq_data:
  netclient_data:


# Border Router - Laptop n1
# AS 65000 - BGP to ISP + Netmaker server

services:
  bird-border:
    build: .
    container_name: bird-border
    hostname: border
    cap_add:
      - NET_ADMIN
    volumes:
      - ./bird.conf:/etc/bird/bird.conf:ro
    network_mode: host  # Port 179 exposed via host networking
    restart: unless-stopped

  # Caddy reverse proxy (TLS termination for netmaker)
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./certs:/certs:ro
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - "443:443"
    depends_on:
      - netmaker
    restart: unless-stopped

  # Netmaker Server
  netmaker:
    image: gravitl/netmaker:v0.24.2
    container_name: netmaker
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      SERVER_NAME: "netmaker"
      SERVER_HOST: "${SERVER_HOST:-172.30.0.100}"  # Physical IP of this machine
      SERVER_API_CONN_STRING: "${SERVER_HOST:-172.30.0.100}"
      SERVER_HTTP_HOST: "${SERVER_HOST:-172.30.0.100}"
      API_PORT: "8081"
      BROKER_ENDPOINT: "mqtt://${SERVER_HOST:-172.30.0.100}:1883"
      COREDNS_ADDR: "${SERVER_HOST:-172.30.0.100}"
      MASTER_KEY: "${MASTER_KEY:-changeme}"
      MQ_HOST: "${SERVER_HOST:-172.30.0.100}"
      MQ_PORT: "1883"
      DATABASE: "sqlite"
      NODE_ID: "netmaker-server"
      VERBOSITY: "3"
    volumes:
      - netmaker_data:/root/data
      - netmaker_certs:/etc/netmaker
    expose:
      - "8081"
    ports:
      - "51821:51821/udp" # WireGuard
    depends_on:
      - mq
    restart: unless-stopped

  # MQTT Broker for Netmaker
  mq:
    image: eclipse-mosquitto:2
    container_name: netmaker-mq
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mq_data:/mosquitto/data
    ports:
      - "1883:1883"
    restart: unless-stopped

  # Netclient on this node
  # NOTE: net.ipv4.ip_forward=1 must be set on the host (sysctls not allowed with network_mode: host)
  netclient:
    image: gravitl/netclient:v0.24.2
    container_name: netclient
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: host
    volumes:
      - netclient_data:/etc/netclient
      - ./certs/server.crt:/etc/ssl/certs/netmaker.crt:ro
    environment:
      TOKEN: "${ENROLLMENT_TOKEN:-}"  # Set after network creation
    restart: unless-stopped

volumes:
  netmaker_data:
  netmaker_certs:
  mq_data:
  netclient_data:
  caddy_data:
  caddy_config:

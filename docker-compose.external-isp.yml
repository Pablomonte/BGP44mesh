# Docker Compose Override for External ISP Connectivity using Macvlan
# Use this on Host B to connect to ISP on Host A with direct L2 access
#
# Usage on Host B:
#   1. Set ISP_ENABLED=true and ISP_NEIGHBOR=<Host_A_IP> in .env
#   2. Configure TINC1_LAN_IP in .env (e.g., 10.233.198.100)
#   3. Deploy with: docker compose -f docker-compose.yml -f docker-compose.macvlan-isp.yml up -d
#
# Prerequisites:
#   - Verify parent interface: ip route | grep default
#   - Choose unused IP on your LAN for tinc1 (e.g., 10.233.198.100)
#   - Ensure IP is not in DHCP range

version: '3.8'

services:
  tinc1:
    networks:
      mesh-net:
      cluster-net:
      isp-net:
        ipv4_address: 172.30.0.3
      lan-macvlan:
        ipv4_address: ${TINC1_LAN_IP:-10.42.0.100}
    extra_hosts:
      - "isp-bird:${ISP_NEIGHBOR:-10.42.0.228}"

networks:
  lan-macvlan:
    driver: macvlan
    driver_opts:
      parent: ${LAN_INTERFACE:-enxa0cec8992ed8}  # Your physical NIC
      macvlan_mode: bridge  # Use bridge mode for better connectivity
    ipam:
      config:
        - subnet: ${LAN_SUBNET:-10.42.0.0/24}
          gateway: ${LAN_GATEWAY:-10.42.0.1}
          ip_range: ${LAN_IP_RANGE:-10.42.0.100/31}  # IP range for tinc1
